<script type="text/javascript">
var globalChannel = 27;
var retry =0,page = 1,pagesize = 20,load = 1,channel = '3',sort = 0,is_simple = true, is_tmall = 0, has_coupon = 0, sort_type='',is_t = false, is_h = false, is_q = false, keyword = '<%= keyword %>', category = '<%= cid ? cid : ""%>', platform = '1', jd_sort = null, jd_is_hot = 0, pdd_sort = 0, pdd_activity = '';

function go_amazon_s(){
  window.open("https://www.amazon.com/s?k=" + encodeURIComponent('<%= @k %>') + "&tag=uucoupon-20");
}
var go_search = function(){
  window.open("https://www.amazon.com/s?k=Hot+Product&tag=uucoupon-20");
}

function createList_dg(cl){
  var obj = $('#dazheList');
  var htmlstr = '';
  for(var i=0,len=cl.length;i<len;i++){
    var z = cl[i];
    htmlstr += '<div class="item">';
    htmlstr += '<a class = "zh" href="/e_detail/'+ z.product_id +'">';
    htmlstr += '<img class="pic" src="'+ z.product_main_image_url +'" alt="'+z.product_title +'"/>';
    htmlstr += '<div class="cent">';
    htmlstr += '<h3>';
    htmlstr += z.product_title;
    htmlstr += '</h3>';
    htmlstr += '<div class="num">';
    htmlstr += '<span>$'+ z.original_price + '</span>';
    if(z.lastest_volume > 0){
      htmlstr += '<span class="r">'+ z.lastest_volume + ' orders </span>';
    }
    htmlstr += '</div>';
    htmlstr += '<div class="money"><div class="quan"><i>-' + z.discount + '</i></div>';
    htmlstr += '$'
    htmlstr += '<span class="m">' + z.sale_price + '</span></div>'
    htmlstr += '</div></a></div>';
  }
  htmlstr = $(htmlstr);
  obj.append(htmlstr);
}

var callback1 = function(data){
  load = 1;
  page ++;
  var r = data.aliexpress_affiliate_product_query_response.resp_result;
  if(r.resp_code == 200){
    createList_dg(r.result.products.product);
    $("#imgLoading").addClass("sno");
    if(r.result.products.product.length >= pagesize || r.result.total_record_count > page * pagesize){
      $("#loadRetry").addClass("sno");
      $("#noMore").addClass("sno");
    }
    else{
      $("#loadRetry").addClass("sno");
      $("#noMore").removeClass("sno");
      load = 0;
    }
  }
  else{
    $("#loadRetry").removeClass("sno");
    $("#imgLoading").addClass("sno");
    $("#noMore").addClass("sno");
  }
};

function getDazheCouponList(){
  if(!load){
    return;
  }
  $("#imgLoading").removeClass("sno");
  $("#loadRetry").addClass("sno");
  $("#noMore").addClass("sno");

  doAliExpress();
}
function doAliExpress(){
  var dd = {
    'keyword': keyword,
    'category': category,
    'sort': sort_type,
    'page':page,
    'callback': 'callback1'
  };
  $.ajax({
    url: "/e_query",
    type: 'GET',
    dataType: 'jsonp',
    data: dd,
    jsonp: 'callback1',
    jsonpCallback: 'callback1',
    beforeSend:function(){
      load = 0;
    },
    success:function(data){
    },
    error: function(data){
      if(!retry){
        retry = 1;
        load = 1;
        getDazheCouponList();
      }
      else{
        $("#loadRetry").removeClass("sno");
        $("#imgLoading").addClass("sno");
        $("#noMore").addClass("sno");
      }
    }
  });
}

function ssSort(id){
  if(id == 2){
    sort_type = "LAST_VOLUME_DESC";
    $("#t2").addClass("active");
    $("#t3").html("Price");
  }
  else if(id == 3){
    sort_type = "SALE_PRICE_ASC";
    $("#t3").html("Price↑");
    $("#tt3").addClass("active");
  }
  else if(id == 4){
    sort_type = "SALE_PRICE_DESC";
    $("#t3").html("Price↓");
    $("#tt3").addClass("active");
  }
  else{
    $("#t1").addClass("active");
  }
}


$(function(){
  $("#radio_1").attr("checked", "checked");
  ssSort(<%= @ss_id ? @ss_id : 0 %>);
  getDazheCouponList();
  $(document).scroll(function(){
    tp = document.body.scrollTop || document.documentElement.scrollTop;
    if(tp > 216){
      $('.scroll_top').removeClass('close');
      $('.scroll_top').addClass('open');
      $('.filter').addClass('fixed');
      $('.platform-filter').addClass('fixed');
    }
    else{
      $('.scroll_top').removeClass('open');
      $('.scroll_top').addClass('close');
      $('.filter').removeClass('fixed');
      $('.platform-filter').removeClass('fixed');
    }
    if(tp >= (document.body.scrollHeight - 800)){
      getDazheCouponList();
    }
  });
  $(".scroll_top>a").click(function(){window.scrollTo(0, 2);});

  $("#loadRetry").click(function(){
    getDazheCouponList();
  });

  $(".type").click(function(){
    var _this = $(this);
    if(_this.data('sort') == '3'){
      if(!_this.hasClass('active')){
        $('.type.active').removeClass('active');
        _this.addClass('active');
        sort_type = "SALE_PRICE_ASC";
        $("#t3").html("Price↑");
      }
      else{
        if(sort_type == "SALE_PRICE_ASC"){
          sort_type = "SALE_PRICE_DESC"
          $("#t3").html("Price↓");
        }else{
          sort_type = "SALE_PRICE_ASC";
          $("#t3").html("Price↑");
        }
      }
      page = 1;
      load = 1;
      $("#dazheList").html("");
      getDazheCouponList();
      return;
    }
    if(!_this.hasClass('active')){
      $('.type.active').removeClass('active');
      _this.addClass('active');
      sort = _this.data('sort');
      if(sort == '1'){
        sort_type = '';
        $("#t3").html("Price");
      }
      else if (sort == '2'){
        sort_type = "LAST_VOLUME_DESC"
        $("#t3").html("Price");
      }
    }
    page = 1;
    load = 1;
    $("#dazheList").html("");
    getDazheCouponList();
  });
});
</script>
